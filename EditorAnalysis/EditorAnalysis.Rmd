---
title: Title of submission to PLOS journal
author:
  - name: Alice Anonymous
    email: alice@example.com
    affiliation: Some Institute of Technology
    corresponding: alice@example.com
  - name: Bob Security
    email: bob@example.com
    affiliation: 
      - Another University
      - Some Institute of Technology
address:
  - code: Some Institute of Technology
    address: Department 1, Street, City, State, Zip
  - code: Another University
    address: Department 2, Street, City, State, Zip
abstract: |
  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur eget porta erat. Morbi consectetur est vel gravida pretium. Suspendisse ut dui eu ante cursus gravida non sed sem. Nullam sapien tellus, commodo id velit id, eleifend volutpat quam. Phasellus mauris velit, dapibus finibus elementum vel, pulvinar non tellus. Nunc pellentesque pretium diam, quis maximus dolor faucibus id. Nunc convallis sodales ante, ut ullamcorper est egestas vitae. Nam sit amet enim ultrices, ultrices elit pulvinar, volutpat risus.
  
author_summary: |
  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur eget porta erat. Morbi consectetur est vel gravida pretium. Suspendisse ut dui eu ante cursus gravida non sed sem. Nullam sapien tellus, commodo id velit id, eleifend volutpat quam. Phasellus mauris velit, dapibus finibus elementum vel, pulvinar non tellus. Nunc pellentesque pretium diam, quis maximus dolor faucibus id. Nunc convallis sodales ante, ut ullamcorper est egestas vitae. Nam sit amet enim ultrices, ultrices elit pulvinar, volutpat risus.

bibliography: mybibfile.bib
output: rticles::plos_article
csl: plos.csl

params:
  doc_refresh_data:
    value: no
    choices:
    - yes
    - no
  doc_debug:
    value: no
    choices:
    - yes
    - no
---

```{r label=setup, include=FALSE}
library(knitr)
## options for this document
doc_debug <- params$doc_debug
doc_refresh_data <- params$doc_refresh_data
knitr::opts_chunk$set("message" = doc_debug)
knitr::opts_chunk$set("warning" = doc_debug)
knitr::opts_chunk$set("tidy" = FALSE) # already tidyed using stylr
knitr::opts_chunk$set(autodep=TRUE)

## check for webshot if pdf output
doc_is_pdf <- 
  try (("pdf_document" %in% rmarkdown::all_output_formats(knitr::current_input())), silent=TRUE)
doc_is_pdf <- (doc_is_pdf == TRUE)
if (doc_is_pdf) {
  require("webshot")
  webshot::install_phantomjs()
}
# works in knit, but not in other environments
try(knitr::dep_auto())
```

```{r r-setup}
# core libraries for tidy data science in R
library(tidyverse)
library(magrittr)
if (doc_debug) {
  require(tidylog)
}
library(gt)
```

```{r fetch-data, include=FALSE}
library("R.utils")
#library("RSQLite")
#library("DBI")
#library("jsonlite")
#library("dbplyr")

###
### OpenEditors Data
### 

db.name <- "openeditors_combined.csv"
if (doc_refresh_data) {
  
   uris <- c(editor1.csv ="https://raw.githubusercontent.com/andreaspacher/openeditors/main/Output/editors1.csv",
            editor2.csv= "https://raw.githubusercontent.com/andreaspacher/openeditors/main/Output/editors2.csv")
   
   tmp.tbl <- NULL
   
   tmpfile <- tempfile(fileext=".csv")

   for (j in 1:length(uris)) {
     i <- uris[j]
     download.file(i,names(i))
     gEnc <- guess_encoding(names(i),n_max=-1)[[1]] # originally tried alternative encodings such as windows-1250, latin1, UTF8, "ISO-8859-1" as encodings,
     tmp.tbl %<>% bind_rows(read_csv(names(i),  locale = readr::locale(encoding = gEnc)))
   }
   write_csv(tmp.tbl,db.name)
   gzip(db.name)
}

editors_raw.tbl <- read_csv(paste(db.name,".gz",sep=""))


###
### DOAJ
###

db.name <- "doaj.csv"
if (doc_refresh_data) {
   download.file("https://doaj.org/csv",db.name)
   gzip(db.name)
}

doaj_raw.tbl <- read_csv(paste(db.name,".gz",sep=""))
rm(db.name)
```

```{r data-clean}
library("rlang")

### DOAJ Cleanup
doaj.tbl <- doaj_raw.tbl
doaj.tbl %<>% pivot_longer(cols=c("Journal ISSN (print version)","Journal EISSN (online version)"),
                           values_to ="issn", names_to ="issn_type ", values_drop_na=TRUE)
# NOTE -- checked that LICENSE, LCC not missing



###
### Editors cleanup
editors.tbl <- editors_raw.tbl

editors.tbl %<>% select(-X1) # strip unnamed rowids in data 
editors.tbl %<>% mutate(across(-c("issn","date","url"),as_utf8_character)) # clean unicode sequences
editors.tbl %<>% mutate(across(-c("issn","date","url"),function(x)str_replace_all(x,'\\<.*\\>',''))) # strip unresolved escapes (TODO: convert latin-1 escape sequences to Unicode rather than strip them)
# TODO: Some journals missing ISSN code, match by name & publisher

### Join editors with journal information
editors.tbl %<>% left_join(doaj.tbl %>% select(issn,"Journal license","LCC Codes"), by="issn")
```

# Abstract

# Introduction

# Materials and Methods

## Gender Imputation

Making scholarship more inclusive requires making the characteristics of those participating visible. Because no systematic public data on self-reported author characteristics exists, however, research on participation in scholarly publications must use bibliometric methods to impute gender from author names. [See, for example, @lariviere2013bibliometrics] To impute the geneder of editors we apply a method that is commonly used in scientometric analysis and which is based on analysis of historical censuses [@blevins2015jane] to impute gender based on author names. We then use this imputation to explore the inclusion of works authored by men and women over time.[^1]

[^1]: This method is intended for aggregate analysis and coarse (binary) classification and not for individual-level analysis -- e.g. the assignment of an pronoun to a specific author. The classification reported in the table is based on the IPUMS corpus. Bootstrap resampling is used to compute confidence intervals -- this reflects sampling error, but not measurement error asising from heuristic name extraction, and uncertainty in name to gender assignment. As a sensitivity check for measurement error we replicated our analyses using two other methods: use of the Social Security Administration database and 'Kantrowitz' method (which is popular in the literature, but based on a much smaller corpus). Notwithstanding -- the range of estimates does not alter the overall substantive conclusions reported above.

    ```{r gender_imputation, cache=TRUE, dependson=knitr::dep_auto()}
    library(gender)
    library(genderdata)
    library(humaniformat) 
    gender_meth <- "ipums"

    doab_df %<>% mutate(LS_NM_AUTHORS=str_split(`Authors`,";"))

    # parse_names fails on empty strings, wrap it# gender can fail on genderize method
    safe_first_name <- possibly(first_name, otherwise="")
    safe_format_reverse <- possibly(format_reverse, otherwise="")
    safe_gender <- possibly(gender, otherwise=list(gender=""))

    doab_df %<>% rowwise() %>% mutate(LS_NM_AUTHORS_R = list(safe_format_reverse (str_squish(`LS_NM_AUTHORS`))))

    doab_df %<>% rowwise() %>% mutate(LS_NM_AUTHOR_FIRST=list(safe_first_name(`LS_NM_AUTHORS_R`)))

    doab_df %<>% ungroup() %>% rowwise() %>% mutate(LS_CAT_GENDERS = list(safe_gender(`LS_NM_AUTHOR_FIRST`,method=gender_meth)[["gender"]]))

    doab_df %<>% rowwise() %>% mutate(
      N_GENDER_MALE=sum(LS_CAT_GENDERS=="male",na.rm=TRUE),  N_GENDER_FEMALE=sum(LS_CAT_GENDERS=="female",na.rm=TRUE),
      )
    ```

# Results

-   Journal: field, OA status
-   Authors: \# Discussion \# References {\#references .unnumbered}

# Appendices

Journals per publisher, and missing ISSN

```{r}
 editors.tbl %>% group_by(journal) %>% slice_head(n=1) %>% group_by(publisher) %>% summarize(n=n(),miss=sum(is.na(issn))) %>% gt()
```

